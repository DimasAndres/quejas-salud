const http = require('http');
const fs = require('fs');
const path = require('path');
const url = require('url');
const bcrypt = require('bcryptjs');
const { enviarNotificacionQueja } = require('./email-service');
const { revisarQueja, sugerirModificacion } = require('./filtro-quejas');

// Almacenamiento en memoria
let users = [];
let quejas = [];
let nextUserId = 1;
let nextQuejaId = 1;

// Datos de configuraci√≥n
const DEPARTAMENTOS = {
    "Amazonas": ["Leticia", "Puerto Nari√±o"],
    "Antioquia": ["Medell√≠n", "Bello", "Itag√º√≠", "Envigado", "Apartad√≥"],
    "Atl√°ntico": ["Barranquilla", "Soledad", "Malambo", "Puerto Colombia"],
    "Bogot√° D.C.": ["Bogot√°"],
    "Bol√≠var": ["Cartagena", "Turbaco", "Magangu√©", "El Carmen de Bol√≠var"],
    "Boyac√°": ["Tunja", "Duitama", "Sogamoso", "Chiquinquir√°"],
    "Caldas": ["Manizales", "La Dorada", "Villamar√≠a", "Riosucio"],
    "Caquet√°": ["Florencia", "San Vicente del Cagu√°n"],
    "Casanare": ["Yopal", "Aguazul", "Villanueva"],
    "Cauca": ["Popay√°n", "Santander de Quilichao", "Puerto Tejada"],
    "Cesar": ["Valledupar", "Aguachica", "La Paz"],
    "Choc√≥": ["Quibd√≥", "Istmina", "Condoto"],
    "C√≥rdoba": ["Monter√≠a", "Lorica", "Ceret√©"],
    "Cundinamarca": ["Soacha", "Zipaquir√°", "Facatativ√°", "Girardot"],
    "Guain√≠a": ["In√≠rida"],
    "Guaviare": ["San Jos√© del Guaviare"],
    "Huila": ["Neiva", "Pitalito", "Garz√≥n"],
    "La Guajira": ["Riohacha", "Maicao", "Fonseca"],
    "Magdalena": ["Santa Marta", "Ci√©naga", "Fundaci√≥n"],
    "Meta": ["Villavicencio", "Acac√≠as", "Granada"],
    "Nari√±o": ["Pasto", "Ipiales", "Tumaco"],
    "Norte de Santander": ["C√∫cuta", "Oca√±a", "Pamplona"],
    "Putumayo": ["Mocoa", "Puerto As√≠s"],
    "Quind√≠o": ["Armenia", "Calarc√°", "Montenegro"],
    "Risaralda": ["Pereira", "Dosquebradas", "La Virginia"],
    "San Andr√©s y Providencia": ["San Andr√©s"],
    "Santander": ["Bucaramanga", "Floridablanca", "Giron", "Barrancabermeja"],
    "Sucre": ["Sincelejo", "Corozal"],
    "Tolima": ["Ibagu√©", "Espinal", "Honda"],
    "Valle del Cauca": ["Cali", "Palmira", "Buenaventura", "Tulu√°", "Cartago"],
    "Vaup√©s": ["Mit√∫"],
    "Vichada": ["Puerto Carre√±o"]
};

const TIPOS_PRIMARIA = [
    "Consulta m√©dica general",
    "Odontolog√≠a b√°sica",
    "Vacunaci√≥n"
];

const TIPOS_COMPLEMENTARIA = [
    "Consulta con especialistas",
    "Cirug√≠as programadas",
    "Terapias (Fisioterapia, psicolog√≠a)"
];

// Funci√≥n para parsear JSON del cuerpo de la petici√≥n
function parseBody(req) {
  return new Promise((resolve, reject) => {
    let body = '';
    req.on('data', chunk => {
      body += chunk.toString();
    });
    req.on('end', () => {
      try {
        resolve(JSON.parse(body));
      } catch (error) {
        resolve({});
      }
    });
  });
}

// Funci√≥n para enviar respuesta JSON
function sendJSON(res, statusCode, data) {
  res.writeHead(statusCode, {
    'Content-Type': 'application/json',
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type'
  });
  res.end(JSON.stringify(data));
}

// Funci√≥n para servir archivos est√°ticos
function serveFile(res, filePath) {
  fs.readFile(filePath, (err, data) => {
    if (err) {
      res.writeHead(404);
      res.end('Archivo no encontrado');
      return;
    }
    
    const ext = path.extname(filePath);
    let contentType = 'text/html';
    if (ext === '.css') contentType = 'text/css';
    if (ext === '.js') contentType = 'application/javascript';
    
    res.writeHead(200, { 'Content-Type': contentType });
    res.end(data);
  });
}

const server = http.createServer(async (req, res) => {
  const parsedUrl = url.parse(req.url, true);
  const pathname = parsedUrl.pathname;
  const method = req.method;

  // Manejar CORS
  if (method === 'OPTIONS') {
    res.writeHead(200, {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type'
    });
    res.end();
    return;
  }

  // API Routes
  if (pathname === '/api/register' && method === 'POST') {
    try {
      const body = await parseBody(req);
      const { nombre, apellido, cedula, celular, correo, tipoUsuario, clave, aceptoPolitica } = body;
      
      // Verificar si el usuario ya existe
      const existingUser = users.find(u => u.cedula === cedula);
      if (existingUser) {
        sendJSON(res, 400, { error: 'Usuario ya existe con esta c√©dula' });
        return;
      }
      
      // Verificar que acepta la pol√≠tica
      if (!aceptoPolitica) {
        sendJSON(res, 400, { error: 'Debe aceptar la pol√≠tica de tratamiento de datos' });
        return;
      }
      
      // Hash de la contrase√±a
      const hashedPassword = await bcrypt.hash(clave, 10);
      
      // Crear usuario
      const newUser = {
        id: nextUserId++,
        nombre,
        apellido,
        cedula,
        celular,
        correo,
        tipoUsuario,
        clave: hashedPassword,
        aceptoPolitica,
        fechaCreacion: new Date()
      };
      
      users.push(newUser);
      console.log(`‚úÖ Usuario registrado: ${nombre} ${apellido} (${tipoUsuario})`);
      
      sendJSON(res, 200, { success: true, userId: newUser.id });
    } catch (error) {
      console.error('Error en registro:', error);
      sendJSON(res, 500, { error: 'Error al registrar usuario' });
    }
    return;
  }

  if (pathname === '/api/login' && method === 'POST') {
    try {
      const body = await parseBody(req);
      const { cedula, clave } = body;
      
      const user = users.find(u => u.cedula === cedula);
      if (!user) {
        sendJSON(res, 401, { error: 'Credenciales inv√°lidas' });
        return;
      }
      
      const validPassword = await bcrypt.compare(clave, user.clave);
      if (!validPassword) {
        sendJSON(res, 401, { error: 'Credenciales inv√°lidas' });
        return;
      }
      
      console.log(`‚úÖ Login exitoso: ${user.nombre} ${user.apellido}`);
      
      sendJSON(res, 200, { 
        success: true, 
        user: { 
          id: user.id, 
          nombre: user.nombre, 
          apellido: user.apellido,
          correo: user.correo,
          tipoUsuario: user.tipoUsuario 
        } 
      });
    } catch (error) {
      console.error('Error en login:', error);
      sendJSON(res, 500, { error: 'Error del servidor' });
    }
    return;
  }

  if (pathname === '/api/quejas' && method === 'POST') {
    try {
      const body = await parseBody(req);
      const { nombre, cedula, correo, celular, problema, detalle, ciudad, departamento, clasificacion, soporte, tipoUsuario, aceptoPolitica } = body;
      
      // Validar datos requeridos
      if (!nombre || !cedula || !correo || !problema || !detalle || !ciudad || !departamento || !clasificacion || !tipoUsuario || !aceptoPolitica) {
        sendJSON(res, 400, { error: 'Faltan campos requeridos' });
        return;
      }
      
      // Crear objeto usuario temporal para el env√≠o de correos
      const usuario = {
        nombre: nombre,
        cedula: cedula,
        correo: correo,
        celular: celular || 'No proporcionado',
        tipoUsuario: tipoUsuario
      };
      
      // Validaci√≥n avanzada de contenido con filtro de lenguaje inapropiado
      const textoCompleto = `${problema} ${detalle}`;
      const resultadoFiltro = revisarQueja(textoCompleto);
      
      if (!resultadoFiltro.esApropiada) {
        const sugerencia = sugerirModificacion(textoCompleto);
        const razones = resultadoFiltro.palabrasEncontradas.join(', ');
        
        console.log(`üö´ Queja rechazada por contenido inapropiado. Razones: ${razones}`);
        
        sendJSON(res, 400, { 
          error: 'El contenido de la queja contiene lenguaje inapropiado para comunicaciones oficiales.',
          detalles: `Problemas detectados: ${razones}`,
          sugerencia: sugerencia,
          mensaje: 'Por favor, reformule su mensaje de manera respetuosa y constructiva. Una comunicaci√≥n adecuada nos ayuda a brindar mejor atenci√≥n a su caso.'
        });
        return;
      }
      
      console.log(`‚úÖ Contenido validado exitosamente`);
      
      const nuevaQueja = {
        id: nextQuejaId++,
        usuarioId: null,
        nombre,
        cedula,
        correo,
        celular,
        problema,
        detalle,
        ciudad,
        departamento,
        clasificacion,
        tipoUsuario,
        aceptoPolitica,
        fechaAceptacionPolitica: new Date().toISOString(),
        soporte: soporte || [],
        estado: 'pendiente',
        fechaCreacion: new Date()
      };
      
      quejas.push(nuevaQueja);
      
      console.log(`üìã Nueva queja registrada: ${problema} - ${departamento} (${clasificacion})`);
      
      // Enviar correos autom√°ticamente
      try {
        const resultadosCorreo = await enviarNotificacionQueja(nuevaQueja, usuario);
        
        let mensajeCorreo = '';
        if (resultadosCorreo.destinatariosEnviado) {
          mensajeCorreo += 'Notificaci√≥n enviada a autoridades de salud. ';
        }
        if (resultadosCorreo.usuarioEnviado) {
          mensajeCorreo += 'Comprobante enviado a su correo. ';
        }
        if (resultadosCorreo.errores.length > 0) {
          console.log('Advertencias en env√≠o de correos:', resultadosCorreo.errores);
        }
        
        sendJSON(res, 200, { 
          success: true, 
          quejaId: nuevaQueja.id,
          mensaje: `Queja registrada exitosamente. ${mensajeCorreo}`.trim()
        });
      } catch (emailError) {
        console.error('Error al enviar correos:', emailError);
        sendJSON(res, 200, { 
          success: true, 
          quejaId: nuevaQueja.id,
          mensaje: 'Queja registrada exitosamente. Error en env√≠o de notificaciones por correo.'
        });
      }
    } catch (error) {
      console.error('Error en queja:', error);
      sendJSON(res, 500, { error: 'Error al registrar queja' });
    }
    return;
  }

  if (pathname.startsWith('/api/quejas/') && method === 'GET') {
    try {
      const userId = parseInt(pathname.split('/')[3]);
      const userQuejas = quejas.filter(q => q.usuarioId === userId);
      
      sendJSON(res, 200, { quejas: userQuejas });
    } catch (error) {
      console.error('Error obteniendo quejas:', error);
      sendJSON(res, 500, { error: 'Error al obtener quejas' });
    }
    return;
  }

  // Obtener departamentos
  if (pathname === '/api/departamentos' && method === 'GET') {
    sendJSON(res, 200, Object.keys(DEPARTAMENTOS));
    return;
  }

  // Obtener municipios por departamento
  if (pathname.startsWith('/api/municipios/') && method === 'GET') {
    const departamento = decodeURIComponent(pathname.split('/')[3]);
    const municipios = DEPARTAMENTOS[departamento] || [];
    sendJSON(res, 200, municipios);
    return;
  }

  // Obtener tipos de queja por clasificaci√≥n
  if (pathname.startsWith('/api/tipos-queja/') && method === 'GET') {
    const clasificacion = pathname.split('/')[3];
    let tipos = [];
    if (clasificacion === 'primaria') {
      tipos = TIPOS_PRIMARIA;
    } else if (clasificacion === 'complementaria') {
      tipos = TIPOS_COMPLEMENTARIA;
    }
    sendJSON(res, 200, tipos);
    return;
  }

  // Obtener informaci√≥n de veedores
  if (pathname === '/api/veedores' && method === 'GET') {
    const veedores = [
      {
        nombre: "Dr. Juan Carlos P√©rez",
        cargo: "Veedor Nacional de Salud",
        departamento: "Nacional",
        telefono: "+57 1 234 5678",
        email: "juan.perez@veeduria.gov.co"
      },
      {
        nombre: "Dra. Mar√≠a Elena Rodr√≠guez",
        cargo: "Veedora Regional Caribe",
        departamento: "Atl√°ntico, Bol√≠var, Cesar, C√≥rdoba, La Guajira, Magdalena, Sucre",
        telefono: "+57 5 987 6543",
        email: "maria.rodriguez@veeduria.gov.co"
      },
      {
        nombre: "Dr. Carlos Andr√©s G√≥mez",
        cargo: "Veedor Regional Pac√≠fico",
        departamento: "Choc√≥, Nari√±o, Valle del Cauca, Cauca",
        telefono: "+57 2 456 7890",
        email: "carlos.gomez@veeduria.gov.co"
      },
      {
        nombre: "Dra. Ana Sof√≠a Mart√≠nez",
        cargo: "Veedora Regional Andina",
        departamento: "Antioquia, Boyac√°, Caldas, Cundinamarca, Huila, Quind√≠o, Risaralda, Santander, Tolima",
        telefono: "+57 4 321 0987",
        email: "ana.martinez@veeduria.gov.co"
      },
      {
        nombre: "Dr. Luis Fernando Torres",
        cargo: "Veedor Regional Oriental",
        departamento: "Arauca, Casanare, Meta, Norte de Santander, Vichada",
        telefono: "+57 7 654 3210",
        email: "luis.torres@veeduria.gov.co"
      },
      {
        nombre: "Dra. Patricia Ram√≠rez",
        cargo: "Veedora Regional Amaz√≥nica",
        departamento: "Amazonas, Caquet√°, Guain√≠a, Guaviare, Putumayo, Vaup√©s",
        telefono: "+57 8 789 0123",
        email: "patricia.ramirez@veeduria.gov.co"
      }
    ];
    sendJSON(res, 200, veedores);
    return;
  }

  // Servir archivos est√°ticos
  if (pathname === '/' || pathname === '/index.html') {
    serveFile(res, 'index.html');
    return;
  }

  // Para cualquier otra ruta, servir index.html (SPA)
  serveFile(res, 'index.html');
});

const PORT = process.env.PORT || 5000;

server.listen(PORT, '0.0.0.0', () => {
  console.log('üöÄ ================================');
  console.log('   VEEDUR√çA NACIONAL DE SALUD');
  console.log('   Sistema de Recepci√≥n de Quejas');
  console.log('üöÄ ================================');
  console.log(`‚úÖ Servidor iniciado en puerto ${PORT}`);
  console.log(`üåê Aplicaci√≥n disponible en http://localhost:${PORT}`);
  console.log('üíæ Usando almacenamiento en memoria');
  console.log('üìä Listo para recibir usuarios y quejas');
  console.log('================================');
});